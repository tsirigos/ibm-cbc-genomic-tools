<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>genomic_apps.rscripts.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">genomic_apps.rscripts.h</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="keyword">const</span> <span class="keywordtype">char</span> *RSCRIPT_TEMPLATE_HEATMAP = \
<a name="l00002"></a>00002 <span class="stringliteral">&quot;\n##\n## USAGE: genomic_apps.heatmap.r DATA-FILE PARAMETER-FILE OUTPUT-IMAGE-FILE\n##\n\nnorm_rows &lt;- function(X) { for (i in 1:nrow(X)) X[i,] &lt;- (X[i,]-mean(X[i,]))/sd(X[i,]); return(X); }\n\nargs &lt;- commandArgs(trailingOnly=T);\ndata_file &lt;- args[1];\nparam_file &lt;- args[2];\nimage_file &lt;- args[3];\n\nparams &lt;- readLines(param_file);\nshift_upstream &lt;- as.numeric(params[1]);\nshift_downstream &lt;- as.numeric(params[2]);\nheatmap_colors &lt;- strsplit(params[3],&#39;,&#39;)[[1]];\nheatmap_title &lt;- strsplit(params[4],&#39;,&#39;)[[1]];\nheatmap_xlab &lt;- params[5];\nheatmap_ylab &lt;- params[6];\nheatmap_size &lt;- as.numeric(strsplit(params[7],&#39;,&#39;)[[1]]);\nheatmap_resolution &lt;- as.numeric(params[8]);\nn_heatmaps &lt;- as.numeric(params[9]);\nimage_type &lt;- rev(unlist(strsplit(image_file,&#39;.&#39;,fixed=T)))[1];\n\n\nlibrary(&#39;MASS&#39;);\nlibrary(&#39;preprocessCore&#39;);           # from Bioconductor\nlibrary(&#39;gplots&#39;);                   # from Bioconductor\n\n# load data\nD &lt;- as.matrix(read.table(data_file,row.names=1,sep=&#39;\t&#39;));\n  \n# create combined heatmap (main version)\nif (image_type==&#39;tif&#39;) {\n  tiff(image_file,width=heatmap_size[1],height=heatmap_size[2],res=heatmap_resolution,compression=&#39;lzw&#39;);\n} else if (image_type==&#39;pdf&#39;) {\n  pdf(image_file); \n}\n\npar(fig=c(0,1,0,1),mar=c(2,2,0,0)); \nplot.new();\nmtext(heatmap_xlab,side=1);\nmtext(heatmap_ylab,side=2);\n\n\nd &lt;- ncol(D)/n_heatmaps;\nI &lt;- 1:d;\ndj &lt;- 0.9/n_heatmaps;\nfor (j in 1:n_heatmaps) {\n  par(fig=c(0.1+(j-1)*dj,0.1+j*dj,0.1,1),mar=c(0.5,0.5,3,0.5),new=TRUE);\n  colorscale &lt;- c(colorpanel(20,low=&#39;white&#39;,high=&#39;white&#39;),colorpanel(50,low=&#39;white&#39;,high=heatmap_colors[j]),colorpanel(30,low=heatmap_colors[j],high=heatmap_colors[j]));\n  image(z=t(norm_rows(D[,I])),col=colorscale,main=heatmap_title[j],xlab=heatmap_xlab,ylab=heatmap_ylab,xaxt=&#39;n&#39;,yaxt=&#39;n&#39;);\n  I &lt;- I+d;\n}\n\ndev.off();\n\n&quot;</span>;
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="keyword">const</span> <span class="keywordtype">char</span> *RSCRIPT_TEMPLATE_PEAKDIFF = \
<a name="l00005"></a>00005 <span class="stringliteral">&quot;# source(&#39;c:/Aris/Research/Code/genomic_tools/genomic_apps.peakdiff.r&#39;);\n\n\n##\n## USAGE: genomic_apps.peakdiff.r DATA-FILE PARAMETER-FILE OUTPUT-IMAGE-FILE\n##\n\n\nmax_abs &lt;- function(a,b) \n{\n  if (abs(a)&gt;abs(b)) a else b\n}\n\nscore_binomial &lt;- function(x,y,n) \n{\n  a &lt;- -pbinom(n*x,n,y,lower.tail=F,log.p=T);\n  b &lt;- pbinom(n*x,n,y,log.p=T);\n  max_abs(a,b)\n}\n\nscore_fold &lt;- function(x,y) \n{\n  return(x/y);\n}\n\nscore &lt;- function(x,y,n,logpval) \n{\n  p &lt;- score_binomial(x,y,n);\n  return(if (abs(p) &lt; -logpval) 1.0 else score_fold(x,y));\n}\n\n\ncalc_fdr_cutoff &lt;- function(pos,neg,fdr) \n{\n  if (fdr&lt;=0) return(Inf);\n  kpos &lt;- 1;\n  kneg &lt;- 1;\n  while ((kpos&lt;=length(pos))&amp;(kneg&lt;=length(neg))) {\n    if ((length(neg)-kneg+1)/(length(pos)-kpos+1)&lt;=fdr) { break; }\n    if (pos[kpos]&lt;neg[kneg]) { kpos &lt;- kpos+1; }\n    else if (pos[kpos]&gt;neg[kneg]) { kneg &lt;- kneg+1; }\n    else { kpos &lt;- kpos+1; kneg &lt;- kneg+1; }\n  }\n  if (kpos&gt;length(pos)) { y &lt;- Inf; }\n  else { y &lt;- pos[kpos]; }\n  return(y);\n}\n\n\nmean_paired_score &lt;- function(signal,ref,win_size,logpval)\n{\n  for (i in 1:length(signal)) s &lt;- s + score(signal[i],ref[i],win_size,logpval);\n  return(s/length(signal));\n}\n\n\npaired_scores &lt;- function(signal,ref,win_size,logpval)\n{\n  s &lt;- signal;\n  for (i in 1:length(signal)) s[i] &lt;- score(signal[i],ref[i],win_size,logpval);\n  return(s);\n}\n\n\ncalc_diff_peaks.plain &lt;- function(D,signal_cols,ref_cols,fdr,win_size,logpval)\n{\n  cat(&#39;Computing scores...\n&#39;);\n  t_over &lt;- apply(D,1,function(x) score(mean(x[signal_cols]),mean(x[ref_cols]),win_size,logpval));\n  t_under &lt;- apply(D,1,function(x) score(mean(x[ref_cols]),mean(x[signal_cols]),win_size,logpval));\n  #t_over &lt;- apply(D,1,function(x) min(paired_scores(x[signal_cols],x[ref_cols],win_size,logpval)));      # use these for paired samples\n  #t_under &lt;- apply(D,1,function(x) min(paired_scores(x[ref_cols],x[signal_cols],win_size,logpval)));\n  cat(&#39;Computing randomized scores...\n&#39;);\n  t_control &lt;- apply(D,1,function(x) mean(c(score(x[signal_cols[1]],x[signal_cols[2]],win_size,logpval),score(x[ref_cols[1]],x[ref_cols[2]],win_size,logpval),score(x[signal_cols[2]],x[signal_cols[1]],win_size,logpval),score(x[ref_cols[2]],x[ref_cols[1]],win_size,logpval))));\n  cat(&#39;Computing FDR scores...\n&#39;);\n  t_over_cutoff &lt;- as.vector(calc_fdr_cutoff(sort(t_over),sort(t_control),fdr));\n  t_under_cutoff &lt;- as.vector(calc_fdr_cutoff(sort(t_under),sort(t_control),fdr));\n  t_over_score &lt;- cbind(t_over,D)[(t_over&gt;=t_over_cutoff),];\n  t_under_score &lt;- -cbind(t_under,D)[(t_under&gt;=t_under_cutoff),];\n  cat(&#39;significant entries (over) = &#39;); cat(nrow(t_over_score)); cat(&#39;\n&#39;);\n  cat(&#39;significant entries (under) = &#39;); cat(nrow(t_under_score)); cat(&#39;\n&#39;);\n  out &lt;- list(D=D,signal_cols=signal_cols,ref_cols=ref_cols,fdr=fdr,t_over=t_over,t_under=t_under,t_control=t_control,t_over_cutoff=t_over_cutoff,t_under_cutoff=t_under_cutoff,t_over_score=t_over_score,t_under_score=t_under_score);\n  calc_diff_peaks.plain.plot.mean(out);\n  return(out);\n}\n\n\n\ncalc_diff_peaks.plain.plot.mean &lt;- function(out)\n{\n  x_label &lt;- colnames(out$D)[out$ref_cols[1]];\n  y_label &lt;- colnames(out$D)[out$signal_cols[1]];\n  x &lt;- apply(out$D[,ref_cols],1,mean);\n  y &lt;- apply(out$D[,signal_cols],1,mean);\n  xlim &lt;- ylim &lt;- log(c(min(c(x,y)),max(c(x,y))));\n  smoothScatter(log(x),out$t_over,xlim=xlim,xlab=paste(x_label,&#39; mean (log)&#39;,sep=&#39;&#39;),ylab=&#39;fold-change&#39;,main=&#39;step 2: differential peak detection&#39;);\n  smoothScatter(log(x),log(y),xlim=xlim,ylim=ylim,xlab=paste(x_label,&#39; mean (log)&#39;,sep=&#39;&#39;),ylab=paste(y_label,&#39; mean (log)&#39;,sep=&#39;&#39;),main=&#39;step 2: differential peak detection&#39;);\n  pos_i &lt;- out$t_over&gt;=out$t_over_cutoff;\n  points(log(x[pos_i]),log(y[pos_i]),pch=19,col=&#39;red&#39;);\n  neg_i &lt;- out$t_under&gt;=out$t_under_cutoff;\n  points(log(x[neg_i]),log(y[neg_i]),pch=19,col=&#39;green&#39;);\n}\n\n\n\n\ncalc_diff_peaks.plain.plot &lt;- function(out)\n{\n  x_label &lt;- colnames(out$D)[out$ref_cols[1]];\n  y_label &lt;- colnames(out$D)[out$signal_cols[1]];\n  x &lt;- out$D[,ref_cols[1]];\n  y &lt;- out$D[,signal_cols[1]];\n  smoothScatter(log(x),log(y),xlab=paste(x_label,&#39; replicate #1 (log)&#39;,sep=&#39;&#39;),ylab=paste(y_label,&#39; replicate #1 (log)&#39;,sep=&#39;&#39;),main=&#39;step 2: differential peak detection&#39;);\n  pos_i &lt;- out$t_over&gt;=out$t_over_cutoff;\n  points(log(x[pos_i]),log(y[pos_i]),pch=19,col=&#39;red&#39;);\n  neg_i &lt;- out$t_under&gt;=out$t_under_cutoff;\n  points(log(x[neg_i]),log(y[neg_i]),pch=19,col=&#39;green&#39;);\n  x &lt;- out$D[,ref_cols[2]];\n  y &lt;- out$D[,signal_cols[2]];\n  smoothScatter(log(x),log(y),xlab=paste(x_label,&#39; replicate #2 (log)&#39;,sep=&#39;&#39;),ylab=paste(y_label,&#39; replicate #2 (log)&#39;,sep=&#39;&#39;),main=&#39;step 2: differential peak detection&#39;);\n  pos_i &lt;- out$t_over&gt;=out$t_over_cutoff;\n  points(log(x[pos_i]),log(y[pos_i]),pch=19,col=&#39;red&#39;);\n  neg_i &lt;- out$t_under&gt;=out$t_under_cutoff;\n  points(log(x[neg_i]),log(y[neg_i]),pch=19,col=&#39;green&#39;);\n}\n\n\n\n\n\nremove_outliers &lt;- function(D,outlier_pval)\n{\n  signal_z &lt;- log(D);\n  signal_label &lt;- colnames(D)[1];\n  smoothScatter(signal_z,xlab=paste(signal_label,&#39; replicate #1 (log)&#39;,sep=&#39;&#39;),ylab=paste(signal_label,&#39; replicate #2 (log)&#39;,sep=&#39;&#39;),main=&#39;step 1: replicate reproducibility&#39;);\n  i &lt;- seq(1,nrow(signal_z),length.out=20000);\n  fit &lt;- loess(signal_z[i,2] ~ signal_z[i,1],span=0.5,degree=1);\n  x &lt;- sort(signal_z[i,1]);\n  lines(x,predict(fit,x),col=&#39;magenta&#39;);\n  r &lt;- signal_z[,2]-predict(fit,signal_z[,1]);\n  w &lt;- dnorm(r,mean(r,na.rm=T),sd(r,na.rm=T))&gt;outlier_pval;\n  w[is.na(w)] &lt;- TRUE;\n  points(signal_z[!w,],pch=19,col=&#39;brown&#39;);\n  return(w);\n}\n\n\n\nnormalize_matrix &lt;- function(D)\n{\n  D_norm &lt;- normalize.quantiles(D);\n  dimnames(D_norm) &lt;- dimnames(D);\n  return(D_norm);\n}\n\n\n\n\n\n\n#\n# MAIN PROGRAM\n#\n\n\nlibrary(&#39;preprocessCore&#39;);\nlibrary(&#39;MASS&#39;);\n\nargs &lt;- commandArgs(trailingOnly=T);\ndata_file &lt;- args[1];\nparam_file &lt;- args[2];\nimage_file &lt;- args[3];\nimage_type &lt;- rev(unlist(strsplit(image_file,&#39;.&#39;,fixed=T)))[1];\n\nparams &lt;- readLines(param_file);\nn_signal_cols &lt;- as.numeric(params[1]);\nn_ref_cols &lt;- as.numeric(params[2]);\nwin_size &lt;- as.numeric(params[3]);\nlogpval &lt;- log(as.numeric(params[4]));\npseudo &lt;- as.numeric(params[5]);         # add minimum possible pseudocount to avoid division by zero in fold-change computation\noutlier_pval &lt;- as.numeric(params[6]);\nfdr &lt;- as.numeric(params[7]);\nsample_labels &lt;- strsplit(params[8],&#39;,&#39;)[[1]];\nimage_size &lt;- as.numeric(strsplit(params[9],&#39;,&#39;)[[1]]);\nimage_resolution &lt;- as.numeric(params[10]);\n\n\n\n\ncat(&#39;Reading input matrix...\n&#39;);\nDATA &lt;- as.matrix(read.table(data_file,row.names=1,sep=&#39;\t&#39;));\nif (nrow(DATA)==0) { cat(&#39;Error: data file is empty!\n&#39;); q(); }\n#DATA &lt;- DATA[seq(1,nrow(DATA),length.out=100000),];\nsignal_cols &lt;- 1:n_signal_cols;\nref_cols &lt;- n_signal_cols+1:n_ref_cols;\ndimnames(DATA)[[2]][signal_cols] = sample_labels[1];\ndimnames(DATA)[[2]][ref_cols] = sample_labels[2];\n\n\n# compute diff peaks\nif (image_type==&#39;tif&#39;) {\n  tiff(image_file,width=image_size[1],height=image_size[2],res=image_resolution,compression=&#39;lzw&#39;);\n} else if (image_type==&#39;pdf&#39;) {\n  pdf(image_file); \n}\nlayout(matrix(1:4,ncol=2,byrow=TRUE));\nD &lt;- normalize_matrix((DATA+pseudo)/(win_size+pseudo));\nw_signal &lt;- remove_outliers(D[,signal_cols],outlier_pval);\nw_ref &lt;- remove_outliers(D[,ref_cols],outlier_pval);\nout &lt;- calc_diff_peaks.plain(D[w_signal&amp;w_ref,],signal_cols,ref_cols,fdr,win_size,logpval); \ndev.off();\nout_file &lt;- paste(data_file,&#39;.FDR=&#39;,fdr,&#39;.score&#39;,sep=&#39;&#39;);\ncat(&#39;output file = &#39;); cat(out_file); cat(&#39;\n&#39;);\nwrite.table(format(rbind(out$t_over_score,out$t_under_score),digits=4),out_file,quote=F,col.names=F,sep=&#39;\t&#39;);\n\n\n\ncat(&#39;Done.\n&#39;);\ncat(&#39;*********************************************************************\n&#39;);\n\n\n&quot;</span>;
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">const</span> <span class="keywordtype">char</span> *RSCRIPT_TEMPLATE_PROFILE = \
<a name="l00008"></a>00008 <span class="stringliteral">&quot;\n##\n## USAGE: genomic_apps.profile.r DATA-FILE PARAMETER-FILE OUTPUT-IMAGE-FILE\n##\n\nargs &lt;- commandArgs(trailingOnly=T);\nprofile_data_file &lt;- args[1];\nprofile_param_file &lt;- args[2];\nprofile_image_file &lt;- args[3];\nimage_type &lt;- rev(unlist(strsplit(profile_image_file,&#39;.&#39;,fixed=T)))[1];\n\nparams &lt;- readLines(profile_param_file);\nprofile_upstream &lt;- as.numeric(params[1]);\nprofile_downstream &lt;- as.numeric(params[2]);\nprofile_legend &lt;- strsplit(params[3],&#39;,&#39;)[[1]];\nprofile_colors &lt;- strsplit(params[4],&#39;,&#39;)[[1]];\nprofile_title &lt;- params[5];\nprofile_xlab &lt;- params[6];\nprofile_ylab &lt;- params[7];\nimage_size &lt;- as.numeric(strsplit(params[8],&#39;,&#39;)[[1]]);\nimage_resolution &lt;- as.numeric(params[9]);\n  \nif (image_type==&#39;tif&#39;) {\n  tiff(profile_image_file,width=image_size[1],height=image_size[2],res=image_resolution,compression=&#39;lzw&#39;);\n} else if (image_type==&#39;pdf&#39;) {\n  pdf(profile_image_file); \n}\nY &lt;- as.matrix(read.table(profile_data_file,header=FALSE,row.names=1,sep=&#39;\t&#39;));\n\nd &lt;- (profile_upstream+profile_downstream)/ncol(Y);\nx &lt;- seq(-profile_upstream+d/2,+profile_downstream-d/2,d);\nplot(x,Y[1,],type=&#39;l&#39;,col=profile_colors[1],main=profile_title,xlab=profile_xlab,ylab=profile_ylab,xlim=c(-profile_upstream,profile_upstream),ylim=c(0,max(Y)));\ni &lt;- 2;\nwhile (i &lt;= nrow(Y)) \n{\n  lines(x,Y[i,],col=profile_colors[i]);\n  i &lt;- i + 1;\n}\nlegend(&#39;topright&#39;,profile_legend,pch=16,col=profile_colors,inset=0.05);\ndev.off();\n\n  \n  \n\n\n&quot;</span>;
<a name="l00009"></a>00009 
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Fri Jun 8 2012 14:22:07 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
